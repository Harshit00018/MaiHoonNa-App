generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  subscriber
  beneficiary
  care_companion
  field_manager
  operations_manager
  emergency_coordinator
  volunteer
}

enum SubscriptionType {
  silver
  gold
  platinum
}

enum VisitStatus {
  scheduled
  in_progress
  completed
  cancelled
}

enum MoodType {
  happy
  neutral
  sad
  depressed
}

enum EmergencyStatus {
  open
  in_progress
  resolved
}

model User {
  id        String   @id @default(uuid())
  phone     String   @unique
  name      String?
  email     String?  @unique
  password  String?
  age       Int?
  role      UserRole @default(subscriber)
  location  String?
  latitude  Float?
  longitude Float?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  beneficiaryProfile      Beneficiary[]         @relation("BeneficiaryUser")
  subscriberBeneficiaries Beneficiary[]         @relation("SubscriberBeneficiaries")
  careCompanionProfile    CareCompanion?
  emergencyRequests       EmergencyRequest[]    @relation("RequestedBy")
  assignedEmergencies     EmergencyRequest[]    @relation("AssignedTo")
  adherenceRecords        MedicationAdherence[]

  @@map("users")
}

model SubscriptionPackage {
  id                String           @id @default(uuid())
  type              SubscriptionType @unique
  name              String
  description       String
  price             Float
  discountSixMonths Float            @default(10.0)
  discountAnnual    Float            @default(20.0)
  durationMonths    Int
  visitsPerWeek     Int
  features          String[]
  isActive          Boolean          @default(true)

  subscriptions Subscription[]

  @@map("subscription_packages")
}

model Subscription {
  id              String           @id @default(uuid())
  subscriberId    String
  beneficiaryId   String
  packageType     SubscriptionType
  startDate       DateTime
  endDate         DateTime
  visitsCompleted Int              @default(0)
  visitsTotal     Int
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())

  package SubscriptionPackage @relation(fields: [packageType], references: [type])

  @@map("subscriptions")
}

model Beneficiary {
  id                String   @id @default(uuid())
  userId            String   @unique
  subscriberId      String
  name              String
  photo             String?
  age               Int
  gender            String
  address           String
  medicalConditions String[]
  medications       String[]
  emergencyContacts Json     @default("[]")
  primaryCcId       String?
  emotionalScore    Float    @default(8.0)
  createdAt         DateTime @default(now())

  user              User                  @relation("BeneficiaryUser", fields: [userId], references: [id])
  subscriber        User                  @relation("SubscriberBeneficiaries", fields: [subscriberId], references: [id])
  primaryCC         CareCompanion?        @relation("PrimaryCC", fields: [primaryCcId], references: [id])
  visits            Visit[]
  medicationList    Medication[]
  adherenceRecords  MedicationAdherence[]
  emergencyRequests EmergencyRequest[]

  @@map("beneficiaries")
}

model CareCompanion {
  id             String   @id @default(uuid())
  userId         String   @unique
  name           String
  photo          String?
  bio            String
  specialization String[]
  zone           String
  isAvailable    Boolean  @default(true)
  createdAt      DateTime @default(now())

  user       User          @relation(fields: [userId], references: [id])
  visits     Visit[]
  primaryFor Beneficiary[] @relation("PrimaryCC")

  @@map("care_companions")
}

model Visit {
  id                  String      @id @default(uuid())
  encounterId         String      @unique
  beneficiaryId       String
  careCompanionId     String
  scheduledTime       DateTime
  checkInTime         DateTime?
  checkOutTime        DateTime?
  status              VisitStatus @default(scheduled)
  vitals              Json?
  mood                MoodType?
  medicationAdherence Boolean     @default(false)
  notes               String?
  locationLat         Float?
  locationLng         Float?
  rating              Int?
  feedback            String?
  createdAt           DateTime    @default(now())

  beneficiary   Beneficiary   @relation(fields: [beneficiaryId], references: [id])
  careCompanion CareCompanion @relation(fields: [careCompanionId], references: [id])

  @@map("visits")
}

model Medication {
  id            String    @id @default(uuid())
  beneficiaryId String
  name          String
  dosage        String
  frequency     String
  timeSlots     String[]
  startDate     DateTime
  endDate       DateTime?
  isActive      Boolean   @default(true)

  beneficiary      Beneficiary           @relation(fields: [beneficiaryId], references: [id])
  adherenceRecords MedicationAdherence[]

  @@map("medications")
}

model MedicationAdherence {
  id            String    @id @default(uuid())
  beneficiaryId String
  medicationId  String
  scheduledTime DateTime
  taken         Boolean   @default(false)
  takenTime     DateTime?
  recordedBy    String

  medication  Medication  @relation(fields: [medicationId], references: [id])
  beneficiary Beneficiary @relation(fields: [beneficiaryId], references: [id])
  recorder    User        @relation(fields: [recordedBy], references: [id])

  @@map("medication_adherence")
}

model EmergencyRequest {
  id            String          @id @default(uuid())
  beneficiaryId String
  requestedBy   String
  status        EmergencyStatus @default(open)
  description   String?
  locationLat   Float?
  locationLng   Float?
  assignedTo    String?
  createdAt     DateTime        @default(now())
  resolvedAt    DateTime?
  notes         Json            @default("[]")

  beneficiary Beneficiary @relation(fields: [beneficiaryId], references: [id])
  requester   User        @relation("RequestedBy", fields: [requestedBy], references: [id])
  assignee    User?       @relation("AssignedTo", fields: [assignedTo], references: [id])

  @@map("emergency_requests")
}

model Otp {
  id        String   @id @default(uuid())
  phone     String   @unique
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@map("otps")
}
